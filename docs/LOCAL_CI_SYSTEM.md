# ğŸ³ æœ¬åœ°CIæ¼”ç»ƒç³»ç»Ÿ - ç¡®ä¿è¿œç¨‹CIå¿…å®šç»¿ç¯

## ğŸ“– æ¦‚è¿°

æœ¬ç³»ç»Ÿå®ç°äº†**æ¨é€å‰æœ¬åœ°æ¨¡æ‹ŸCIæ¼”ç»ƒæœºåˆ¶**ï¼Œé€šè¿‡Dockerå®¹å™¨å®Œå…¨æ¨¡æ‹Ÿè¿œç¨‹GitHub Actionsç¯å¢ƒï¼Œç¡®ä¿æœ¬åœ°CIé€šè¿‡åï¼Œè¿œç¨‹CIå¿…å®šæˆåŠŸã€‚

### ğŸ¯ æ ¸å¿ƒç‰¹æ€§

- âœ… **100%ä¸€è‡´æ€§**ï¼šæœ¬åœ°Dockerç¯å¢ƒä¸è¿œç¨‹GitHub Actionså®Œå…¨ç›¸åŒ
- âœ… **è‡ªåŠ¨è§¦å‘**ï¼šæ¯æ¬¡`git push`å‰è‡ªåŠ¨æ‰§è¡Œå®Œæ•´CIæ£€æŸ¥
- âœ… **æ™ºèƒ½é˜»æ–­**ï¼šCIå¤±è´¥æ—¶é˜»æ­¢æ¨é€ï¼Œæä¾›è¯¦ç»†ä¿®å¤å»ºè®®
- âœ… **è‡ªåŠ¨ä¿®å¤**ï¼šæ”¯æŒè‡ªåŠ¨ä¿®å¤å¸¸è§é—®é¢˜ï¼ˆæ ¼å¼åŒ–ã€ä¾èµ–ç­‰ï¼‰
- âœ… **å®¹é”™æœºåˆ¶**ï¼šDockerå¤±è´¥æ—¶è‡ªåŠ¨é™çº§åˆ°æœ¬åœ°CI
- âœ… **è¯¦ç»†æ—¥å¿—**ï¼šå®Œæ•´çš„æ‰§è¡Œæ—¥å¿—å’Œé”™è¯¯è¯Šæ–­

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
ğŸ“ é¡¹ç›®æ ¹ç›®å½•/
â”œâ”€â”€ ğŸ³ Dockerfile.ci                    # CI Dockeré•œåƒå®šä¹‰
â”œâ”€â”€ ğŸª .git/hooks/pre-push              # Gitæ¨é€å‰Hook
â”œâ”€â”€ ğŸ“ scripts/ci/
â”‚   â”œâ”€â”€ ğŸ­ local_ci_orchestrator.sh     # Dockerå®¹å™¨ç¼–æ’å™¨
â”‚   â””â”€â”€ ğŸš€ local_ci_runner.sh           # CIæ‰§è¡Œè„šæœ¬
â””â”€â”€ ğŸ“‹ Makefile                         # ä»»åŠ¡é›†æˆ
```

### ğŸ”„ æ‰§è¡Œæµç¨‹

```mermaid
graph TD
    A[git push] --> B{æ£€æŸ¥é¡¹ç›®ç¯å¢ƒ}
    B -->|æœ‰æ•ˆ| C{Dockerå¯ç”¨?}
    B -->|æ— æ•ˆ| Z[è·³è¿‡æ£€æŸ¥]
    
    C -->|æ˜¯| D[æ„å»º/ä½¿ç”¨CIé•œåƒ]
    C -->|å¦| I[æœ¬åœ°CIå¤‡ç”¨]
    
    D --> E[å¯åŠ¨Dockerå®¹å™¨]
    E --> F[æ‰§è¡Œå®Œæ•´CIæµç¨‹]
    F --> G{CIé€šè¿‡?}
    
    I --> J[æœ¬åœ°ç¯å¢ƒCI]
    J --> K{æœ¬åœ°CIé€šè¿‡?}
    
    G -->|æ˜¯| L[å…è®¸æ¨é€]
    G -->|å¦| M[é˜»æ­¢æ¨é€ + ä¿®å¤å»ºè®®]
    K -->|æ˜¯| L
    K -->|å¦| M
    
    M --> N[è‡ªåŠ¨ä¿®å¤é€‰é¡¹]
    N --> O[é‡æ–°æ£€æŸ¥]
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. éªŒè¯ç¯å¢ƒ

```bash
# æ£€æŸ¥CIç¯å¢ƒå¥åº·çŠ¶æ€
make ci.doctor
```

### 2. æ„å»ºCIé•œåƒ

```bash
# é¦–æ¬¡æ„å»ºCI Dockeré•œåƒ
make ci.docker.build
```

### 3. æµ‹è¯•æœ¬åœ°CI

```bash
# è¿è¡Œå®Œæ•´Docker CIæ£€æŸ¥
make ci.docker.new

# æˆ–ä½¿ç”¨åˆ«å
make docker-ci
```

### 4. æ­£å¸¸å¼€å‘æµç¨‹

```bash
# æ­£å¸¸æ¨é€ - ä¼šè‡ªåŠ¨è§¦å‘CIæ£€æŸ¥
git add .
git commit -m "feat: æ–°åŠŸèƒ½"
git push  # ğŸš¦ è‡ªåŠ¨è§¦å‘æœ¬åœ°CIæ¼”ç»ƒ
```

## ğŸ“‹ å¯ç”¨å‘½ä»¤

### ğŸ³ Docker CI å‘½ä»¤

| å‘½ä»¤ | æè¿° | ç”¨é€” |
|------|------|------|
| `make ci.docker.new` | è¿è¡Œå®Œæ•´Docker CI | ä¸»è¦CIæ£€æŸ¥æ–¹å¼ |
| `make ci.docker.build` | æ„å»ºCIé•œåƒ | é¦–æ¬¡ä½¿ç”¨æˆ–æ›´æ–° |
| `make ci.docker.rebuild` | å¼ºåˆ¶é‡å»ºé•œåƒ | è§£å†³ç¯å¢ƒé—®é¢˜ |
| `make ci.docker.run` | äº¤äº’å¼CIå®¹å™¨ | è°ƒè¯•é—®é¢˜ |
| `make ci.docker.clean` | æ¸…ç†Dockerèµ„æº | æ¸…ç†ç©ºé—´ |

### ğŸ”§ è¾…åŠ©å‘½ä»¤

| å‘½ä»¤ | æè¿° | ç”¨é€” |
|------|------|------|
| `make ci.doctor` | ç¯å¢ƒè¯Šæ–­ | é—®é¢˜æ’æŸ¥ |
| `make ci.enhanced` | æœ¬åœ°å¿«é€ŸCI | å¤‡ç”¨æ–¹æ¡ˆ |
| `make ci.fix` | è‡ªåŠ¨ä¿®å¤ | ä¿®å¤å¸¸è§é—®é¢˜ |

### ğŸ·ï¸ ä¾¿æ·åˆ«å

| åˆ«å | å¯¹åº”å‘½ä»¤ | æè¿° |
|------|----------|------|
| `docker-ci` | `ci.docker.new` | è¿è¡ŒDocker CI |
| `build-ci` | `ci.docker.build` | æ„å»ºCIé•œåƒ |
| `clean-ci` | `ci.docker.clean` | æ¸…ç†CIèµ„æº |

## âš™ï¸ é…ç½®é€‰é¡¹

### Git Hook é…ç½®

å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶Hookè¡Œä¸ºï¼š

```bash
# è·³è¿‡CIæ£€æŸ¥
SKIP_CI=true git push

# å®Œå…¨è·³è¿‡Hook
git push --no-verify
```

### Docker CI é…ç½®

ç¼–è¾‘ `.git/hooks/pre-push` ä¸­çš„é…ç½®å˜é‡ï¼š

```bash
# æ˜¯å¦ä½¿ç”¨Docker CI
USE_DOCKER_CI=true

# Dockerå¤±è´¥æ—¶æ˜¯å¦é™çº§åˆ°æœ¬åœ°CI
FALLBACK_TO_LOCAL=true

# CIè¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
CI_TIMEOUT=600
```

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. Dockeré•œåƒæ„å»ºå¤±è´¥

```bash
# é—®é¢˜è¯Šæ–­
make ci.doctor

# å¼ºåˆ¶é‡å»º
make ci.docker.rebuild

# æ¸…ç†åé‡å»º
make ci.docker.clean
make ci.docker.build
```

#### 2. CIæ£€æŸ¥å¤±è´¥

```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
cat /tmp/ci-output.log

# è‡ªåŠ¨ä¿®å¤å¸¸è§é—®é¢˜
make ci.fix

# æ‰‹åŠ¨ä¿®å¤åé‡è¯•
make ci.docker.new
```

#### 3. Dockerç¯å¢ƒé—®é¢˜

```bash
# æ£€æŸ¥DockerçŠ¶æ€
docker info

# å¯åŠ¨Docker daemon
sudo systemctl start docker

# æµ‹è¯•Dockerè¿è¡Œ
docker run hello-world
```

#### 4. æƒé™é—®é¢˜

```bash
# ä¿®å¤è„šæœ¬æƒé™
chmod +x scripts/ci/*.sh
chmod +x .git/hooks/pre-push

# ä¿®å¤Dockeræƒé™
sudo usermod -aG docker $USER
# é‡æ–°ç™»å½•ç”Ÿæ•ˆ
```

### é”™è¯¯ç è¯´æ˜

| é€€å‡ºç  | å«ä¹‰ | è§£å†³æ–¹æ¡ˆ |
|--------|------|----------|
| 0 | æˆåŠŸ | æ­£å¸¸æ¨é€ |
| 1 | CIæ£€æŸ¥å¤±è´¥ | æŸ¥çœ‹æ—¥å¿—ä¿®å¤é—®é¢˜ |
| 124 | è¶…æ—¶ | å¢åŠ è¶…æ—¶æ—¶é—´æˆ–ä¼˜åŒ–ä»£ç  |
| 125 | Dockeré”™è¯¯ | æ£€æŸ¥Dockerç¯å¢ƒ |

## ğŸ“ˆ é«˜çº§ç”¨æ³•

### è‡ªå®šä¹‰CIæµç¨‹

ä¿®æ”¹ `scripts/ci/local_ci_runner.sh` ä¸­çš„æ£€æŸ¥é¡¹ç›®ï¼š

```bash
# æ·»åŠ è‡ªå®šä¹‰æ£€æŸ¥
custom_check() {
    log_step "è‡ªå®šä¹‰æ£€æŸ¥"
    # ä½ çš„æ£€æŸ¥é€»è¾‘
    if your_check_command; then
        add_result "SUCCESS" "è‡ªå®šä¹‰æ£€æŸ¥" "é€šè¿‡"
    else
        add_result "FAILURE" "è‡ªå®šä¹‰æ£€æŸ¥" "å¤±è´¥åŸå› "
        return 1
    fi
    return 0
}
```

### é›†æˆåˆ°IDE

#### VS Code é…ç½®

åœ¨ `.vscode/tasks.json` ä¸­æ·»åŠ ï¼š

```json
{
    "version": "2.0.0",
    "tasks": [
        {
            "label": "Docker CI",
            "type": "shell",
            "command": "make",
            "args": ["ci.docker.new"],
            "group": {
                "kind": "test",
                "isDefault": true
            },
            "presentation": {
                "echo": true,
                "reveal": "always",
                "focus": false,
                "panel": "shared"
            }
        }
    ]
}
```

### CIæ€§èƒ½ä¼˜åŒ–

#### 1. é•œåƒç¼“å­˜ä¼˜åŒ–

```bash
# å®šæœŸæ¸…ç†æ— ç”¨é•œåƒ
docker system prune -f

# ä½¿ç”¨æ„å»ºç¼“å­˜
docker build --cache-from football-predict-ci:latest \
  -t football-predict-ci:latest -f Dockerfile.ci .
```

#### 2. å¹¶è¡Œæ‰§è¡Œ

ä¿®æ”¹CIè„šæœ¬ï¼Œæ”¯æŒå¹¶è¡Œæ‰§è¡Œæ£€æŸ¥é¡¹ï¼š

```bash
# å¹¶è¡Œæ‰§è¡Œæ£€æŸ¥
{
    format_check &
    lint_check &
    security_check &
    wait
}
```

## ğŸ“Š ç›‘æ§å’Œç»Ÿè®¡

### CIæ‰§è¡Œç»Ÿè®¡

```bash
# æŸ¥çœ‹CIæ‰§è¡Œå†å²
grep "CIæ‰§è¡ŒæŠ¥å‘Š" /tmp/ci-output.log

# ç»Ÿè®¡æˆåŠŸç‡
grep -c "æ‰€æœ‰æ£€æŸ¥é€šè¿‡" /tmp/ci-output.log
```

### æ€§èƒ½åˆ†æ

```bash
# åˆ†ææ‰§è¡Œæ—¶é—´
grep "æ€»æ‰§è¡Œæ—¶é—´" /tmp/ci-output.log | tail -10

# æŸ¥çœ‹å„æ­¥éª¤è€—æ—¶
grep "è€—æ—¶:" /tmp/ci-output.log
```

## ğŸ”„ ç‰ˆæœ¬åŒæ­¥

### ä¿æŒä¸è¿œç¨‹CIä¸€è‡´

1. **å®šæœŸæ›´æ–°Dockerfile.ci**ï¼š
   - åŒæ­¥GitHub Actionsçš„ubuntuç‰ˆæœ¬
   - æ›´æ–°Pythonå’Œå·¥å…·ç‰ˆæœ¬

2. **åŒæ­¥CIæ­¥éª¤**ï¼š
   - å¯¹æ¯” `.github/workflows/ci.yml`
   - æ›´æ–° `local_ci_runner.sh`

3. **ä¾èµ–ç‰ˆæœ¬åŒæ­¥**ï¼š

   ```bash
   # å®šæœŸæ›´æ–°ä¾èµ–
   uv sync --upgrade
   make ci.docker.rebuild
   ```

## ğŸ‰ æœ€ä½³å®è·µ

### 1. å¼€å‘å·¥ä½œæµ

```bash
# æ¨èçš„å¼€å‘æµç¨‹
git checkout -b feature/new-feature
# ... å¼€å‘ä»£ç  ...
make ci.fix                  # è‡ªåŠ¨ä¿®å¤é—®é¢˜
make ci.docker.new          # æœ¬åœ°CIéªŒè¯
git add .
git commit -m "feat: æ–°åŠŸèƒ½"
git push                     # è‡ªåŠ¨CIé€šè¿‡åæ¨é€
```

### 2. å›¢é˜Ÿåä½œ

- **ç»Ÿä¸€ç¯å¢ƒ**ï¼šæ‰€æœ‰å›¢é˜Ÿæˆå‘˜ä½¿ç”¨ç›¸åŒçš„CIé•œåƒ
- **å®šæœŸæ›´æ–°**ï¼šæ¯å‘¨æ›´æ–°CIé•œåƒ
- **å…±äº«é…ç½®**ï¼šå°†CIé…ç½®åŠ å…¥ç‰ˆæœ¬æ§åˆ¶

### 3. æ€§èƒ½è€ƒè™‘

- **å¢é‡æ£€æŸ¥**ï¼šåªæ£€æŸ¥ä¿®æ”¹çš„æ–‡ä»¶
- **ç¼“å­˜åˆ©ç”¨**ï¼šå……åˆ†åˆ©ç”¨Dockerå±‚ç¼“å­˜
- **å¹¶è¡Œæ‰§è¡Œ**ï¼šæ”¯æŒå¤šæ ¸å¹¶è¡Œæ£€æŸ¥

## ğŸ“ æ”¯æŒå’Œåé¦ˆ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. è¿è¡Œ `make ci.doctor` è¯Šæ–­
2. æŸ¥çœ‹ `/tmp/ci-output.log` è¯¦ç»†æ—¥å¿—
3. å‚è€ƒæœ¬æ–‡æ¡£çš„æ•…éšœæ’é™¤éƒ¨åˆ†
4. è”ç³»å›¢é˜Ÿè·å¾—å¸®åŠ©

---

**ğŸ¯ ç›®æ ‡**ï¼šç¡®ä¿æ¯æ¬¡æ¨é€éƒ½æ˜¯æˆåŠŸçš„æ¨é€ï¼Œè®©è¿œç¨‹CIæ°¸è¿œç»¿ç¯ï¼ğŸŸ¢
