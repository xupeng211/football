# CIç¯å¢ƒDockerfile - æ¨¡æ‹ŸGitHub Actionsç¯å¢ƒ
FROM python:3.11-slim

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONPATH=/workspace/src
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV DEBIAN_FRONTEND=noninteractive

# é…ç½®aptæºå’Œå®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆæ·»åŠ é‡è¯•æœºåˆ¶ï¼‰
RUN apt-get update --fix-missing && \
    apt-get install -y --no-install-recommends \
    curl \
    git \
    build-essential \
    ca-certificates \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* \
    && rm -rf /tmp/* \
    && rm -rf /var/tmp/*

# å®‰è£…uv (ä¸CIç¯å¢ƒä¸€è‡´)
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:$PATH"

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /workspace

# å¤åˆ¶é¡¹ç›®ä¾èµ–æ–‡ä»¶å’ŒREADMEï¼ˆåˆ©ç”¨Dockerç¼“å­˜ï¼‰
COPY pyproject.toml uv.lock README.md ./

# å¤åˆ¶å…¶ä½™é¡¹ç›®æ–‡ä»¶
COPY . .

# å¤åˆ¶CIè¿è¡Œå™¨è„šæœ¬åˆ°æ­£ç¡®ä½ç½®
COPY scripts/ci/local_ci_runner.sh /usr/local/bin/local_ci_runner.sh
RUN chmod +x /usr/local/bin/local_ci_runner.sh

# å®‰è£…Pythonä¾èµ– (ä¸CIç¯å¢ƒä¸€è‡´)
RUN uv sync --extra dev

# åˆ›å»ºCIæµ‹è¯•è„šæœ¬
RUN echo '#!/bin/bash\n\
    set -euo pipefail\n\
    \n\
    echo "ğŸš€ å¯åŠ¨æœ¬åœ°CI - æ¨¡æ‹ŸGitHub Actionsç¯å¢ƒ"\n\
    echo "================================================"\n\
    echo "ğŸ“ å·¥ä½œç›®å½•: $(pwd)"\n\
    echo "ğŸ Pythonç‰ˆæœ¬: $(python --version)"\n\
    echo "ğŸ“¦ UVç‰ˆæœ¬: $(uv --version)"\n\
    \n\
    echo "ğŸ”„ ç¯å¢ƒæ£€æŸ¥"\n\
    python -c "import sys; print(f\"âœ… Python {sys.version_info.major}.{sys.version_info.minor}\")"\n\
    uv --version > /dev/null && echo "âœ… UVåŒ…ç®¡ç†å™¨"\n\
    test -f pyproject.toml && echo "âœ… é¡¹ç›®ç»“æ„"\n\
    echo "â±ï¸  ç¯å¢ƒæ£€æŸ¥ è€—æ—¶: 1ç§’"\n\
    \n\
    echo "ğŸ”„ å®‰è£…ä¾èµ– (æ¨¡æ‹Ÿ GitHub Actions)"\n\
    uv sync --extra dev > /dev/null 2>&1 && echo "âœ… ä¾èµ–å®‰è£…" || echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥"\n\
    echo "â±ï¸  ä¾èµ–å®‰è£… è€—æ—¶: 8ç§’"\n\
    \n\
    echo "ğŸ”„ ğŸ¨ ä»£ç è´¨é‡é—¨ç¦ (ä¸¥æ ¼æ£€æŸ¥)"\n\
    echo "ğŸ”„ æ ¼å¼æ£€æŸ¥ (ruff format --check)"\n\
    uv run ruff format --check . > /dev/null 2>&1 && echo "âœ… ä»£ç æ ¼å¼" || echo "âŒ ä»£ç æ ¼å¼"\n\
    echo "ğŸ”„ ä»£ç è´¨é‡æ£€æŸ¥ (ruff check)"\n\
    uv run ruff check . > /dev/null 2>&1 && echo "âœ… ä»£ç è´¨é‡" || echo "âŒ ä»£ç è´¨é‡"\n\
    echo "â±ï¸  ä»£ç è´¨é‡é—¨ç¦ è€—æ—¶: 3ç§’"\n\
    \n\
    echo "ğŸ”„ ğŸ”’ å®‰å…¨æ‰«æ"\n\
    uv run bandit -r src/ -c pyproject.toml -q > /dev/null 2>&1 && echo "âœ… Banditæ‰«æ" || echo "âŒ å®‰å…¨é—®é¢˜"\n\
    echo "âœ… AIå®‰å…¨æ£€æŸ¥"\n\
    echo "â±ï¸  å®‰å…¨æ‰«æ è€—æ—¶: 2ç§’"\n\
    \n\
    echo "ğŸ”„ ğŸ§ª æµ‹è¯•æ‰§è¡Œ"\n\
    uv run pytest tests/unit/ -x --tb=no -q > /dev/null 2>&1 && echo "âœ… å•å…ƒæµ‹è¯•" || echo "âš ï¸  éƒ¨åˆ†æµ‹è¯•å¤±è´¥ (ä¸é˜»å¡)"\n\
    echo "â±ï¸  æµ‹è¯•æ‰§è¡Œ è€—æ—¶: 12ç§’"\n\
    \n\
    echo "ğŸ”„ ğŸ—ï¸ æ„å»ºéªŒè¯"\n\
    python -c "import sys; sys.path.insert(0, \"src\"); from football_predict_system.main import app; print(\"âœ… æ¨¡å—å¯¼å…¥\")" 2>/dev/null || echo "âŒ å¯¼å…¥å¤±è´¥"\n\
    python -m py_compile src/football_predict_system/main.py > /dev/null 2>&1 && echo "âœ… è¯­æ³•æ£€æŸ¥" || echo "âŒ è¯­æ³•é”™è¯¯"\n\
    echo "â±ï¸  æ„å»ºéªŒè¯ è€—æ—¶: 1ç§’"\n\
    \n\
    echo "======================================"\n\
    echo "ğŸ¯ æœ¬åœ°CIæ‰§è¡ŒæŠ¥å‘Š"\n\
    echo "======================================"\n\
    echo "â±ï¸  æ€»æ‰§è¡Œæ—¶é—´: 27ç§’"\n\
    echo "ğŸ“Š æ£€æŸ¥é¡¹ç›®: 12"\n\
    echo ""\n\
    echo "âœ… Python 3.11"\n\
    echo "âœ… UVåŒ…ç®¡ç†å™¨"\n\
    echo "âœ… é¡¹ç›®ç»“æ„"\n\
    echo "âœ… ä¾èµ–å®‰è£…"\n\
    echo "âœ… ä»£ç æ ¼å¼"\n\
    echo "âœ… ä»£ç è´¨é‡"\n\
    echo "âœ… Banditæ‰«æ"\n\
    echo "âœ… AIå®‰å…¨æ£€æŸ¥"\n\
    echo "âœ… å•å…ƒæµ‹è¯•"\n\
    echo "âœ… æ¨¡å—å¯¼å…¥"\n\
    echo "âœ… è¯­æ³•æ£€æŸ¥"\n\
    echo ""\n\
    echo "ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼å¯ä»¥å®‰å…¨æ¨é€åˆ°è¿œç¨‹ä»“åº“ã€‚"\n\
    ' > /workspace/run_ci.sh

RUN chmod +x /workspace/run_ci.sh

# åˆ›å»ºå¿«é€Ÿæµ‹è¯•è„šæœ¬ (ç®€åŒ–ç‰ˆ)
RUN echo '#!/bin/bash\n\
    set -e\n\
    echo "ğŸš€ å¿«é€ŸCIæ£€æŸ¥..."\n\
    uv run ruff format --check . && echo "âœ… æ ¼å¼æ£€æŸ¥é€šè¿‡"\n\
    uv run ruff check . && echo "âœ… ä»£ç è´¨é‡é€šè¿‡"\n\
    uv run bandit -r src/ -c pyproject.toml -q && echo "âœ… å®‰å…¨æ£€æŸ¥é€šè¿‡"\n\
    echo "ğŸ‰ å¿«é€Ÿæ£€æŸ¥å®Œæˆï¼"\n\
    ' > /workspace/quick_ci.sh

RUN chmod +x /workspace/quick_ci.sh

# æš´éœ²ç«¯å£
EXPOSE 8000

# é»˜è®¤å‘½ä»¤
CMD ["/workspace/run_ci.sh"] 