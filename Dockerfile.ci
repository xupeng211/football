# CIç¯å¢ƒDockerfile - æ¨¡æ‹ŸGitHub Actionsç¯å¢ƒ
FROM python:3.11-slim

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONPATH=/app/src
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    curl \
    git \
    build-essential \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…uv (ä¸CIç¯å¢ƒä¸€è‡´)
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:$PATH"

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶
COPY . /app/

# å®‰è£…Pythonä¾èµ– (ä¸CIç¯å¢ƒä¸€è‡´)
RUN uv sync --extra dev

# åˆ›å»ºCIæµ‹è¯•è„šæœ¬
RUN echo '#!/bin/bash\n\
    set -euo pipefail\n\
    \n\
    echo "ğŸ§ª Running CI Quality Gate Tests..."\n\
    \n\
    # ä»£ç è´¨é‡æ£€æŸ¥\n\
    echo "ğŸ¨ Format Check..."\n\
    uv run ruff format --check .\n\
    \n\
    echo "ğŸ” Lint Check..."\n\
    uv run ruff check src/ --output-format=github\n\
    \n\
    echo "ğŸ”’ Security Check..."\n\
    uv run bandit -r src/ -c pyproject.toml\n\
    \n\
    echo "ğŸ§ª Running Tests..."\n\
    uv run pytest tests/ -v --tb=short --cov=src --cov-report=xml --cov-report=term\n\
    \n\
    echo "âœ… All CI checks passed!"\n\
    ' > /app/run_ci_tests.sh

RUN chmod +x /app/run_ci_tests.sh

# åˆ›å»ºå¿«é€Ÿæµ‹è¯•è„šæœ¬
RUN echo '#!/bin/bash\n\
    set -euo pipefail\n\
    \n\
    echo "ğŸš€ Quick Test - Module Import & Basic Functionality"\n\
    \n\
    # æ¨¡å—å¯¼å…¥æµ‹è¯•\n\
    python -c "\n\
    import sys\n\
    sys.path.insert(0, \"src\")\n\
    \n\
    print(\"âœ… Testing core modules...\")\n\
    from football_predict_system.core.config import get_settings\n\
    from football_predict_system.core.database import get_database_manager\n\
    from football_predict_system.domain.models import Match, Team\n\
    print(\"âœ… Core modules imported successfully\")\n\
    \n\
    print(\"âœ… Testing data platform modules...\")\n\
    from football_predict_system.data_platform.sources.base import DataSource\n\
    from football_predict_system.data_platform.sources.football_data_api import FootballDataAPICollector\n\
    from football_predict_system.data_platform.storage.database_writer import DatabaseWriter\n\
    from football_predict_system.data_platform.config import get_data_platform_config\n\
    print(\"âœ… Data platform modules imported successfully\")\n\
    \n\
    print(\"âœ… Testing cache modules...\")\n\
    from football_predict_system.core.cache import get_cache_manager\n\
    print(\"âœ… Cache modules imported successfully\")\n\
    \n\
    print(\"ğŸ‰ All module imports successful!\")\n\
    "\n\
    ' > /app/quick_test.sh

RUN chmod +x /app/quick_test.sh

# æš´éœ²ç«¯å£
EXPOSE 8000

# é»˜è®¤å‘½ä»¤
CMD ["/bin/bash"] 