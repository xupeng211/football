.PHONY: install fmt lint type test sec leaks ci clean help
.DEFAULT_GOAL := help

# 颜色定义
YELLOW := \033[1;33m
GREEN := \033[1;32m
RED := \033[1;31m
NC := \033[0m

help: ## 显示帮助信息
	@echo "$(YELLOW)Available targets:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-12s$(NC) %s\n", $$1, $$2}'

install: ## 安装项目依赖和开发工具
	@echo "$(YELLOW)Installing dependencies...$(NC)"
	pip install -U pip uv
	pip install -r requirements.txt
	pip install -e .
	pip install pre-commit ruff mypy pytest pytest-cov bandit
	@echo "$(GREEN)✅ Dependencies installed$(NC)"

fmt: ## 格式化代码 (ruff + black)
	@echo "$(YELLOW)Formatting code...$(NC)"
	ruff format .
	ruff check --fix .
	@echo "$(GREEN)✅ Code formatted$(NC)"

lint: ## 代码风格检查 (ruff)
	@echo "$(YELLOW)Running linter...$(NC)"
	ruff check .
	@echo "$(GREEN)✅ Linting passed$(NC)"

type: ## 类型检查 (mypy)
	@echo "$(YELLOW)Running type checker...$(NC)"
	mypy .
	@echo "$(GREEN)✅ Type checking passed$(NC)"

test: ## 运行测试 (pytest)
	@echo "$(YELLOW)Running tests...$(NC)"
	pytest -v
	@echo "$(GREEN)✅ Tests passed$(NC)"

sec: ## 安全检查 (bandit)
	@echo "$(YELLOW)Running security check...$(NC)"
	bandit -r . -f json -o bandit-report.json --exit-zero
	bandit -r . --configfile pyproject.toml
	@echo "$(GREEN)✅ Security check passed$(NC)"

leaks: ## 秘密泄露检查 (gitleaks)
	@echo "$(YELLOW)Running secrets scan...$(NC)"
	@if command -v gitleaks >/dev/null 2>&1; then \
		gitleaks detect --config .gitleaks.toml --verbose --no-banner; \
		echo "$(GREEN)✅ No secrets detected$(NC)"; \
	else \
		echo "$(RED)⚠️  gitleaks not installed, skipping...$(NC)"; \
	fi

ci: install fmt lint type sec test ## 完整CI检查流程
	@echo "$(GREEN)🎉 All CI checks passed!$(NC)"

clean: ## 清理生成的文件
	@echo "$(YELLOW)Cleaning up...$(NC)"
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -exec rm -rf {} +
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	rm -rf .pytest_cache .mypy_cache .ruff_cache
	rm -rf htmlcov/ .coverage coverage.xml
	rm -f bandit-report.json
	@echo "$(GREEN)✅ Cleanup complete$(NC)"
