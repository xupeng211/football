.PHONY: install fmt lint type test sec leaks ci clean help
.DEFAULT_GOAL := help

# é¢œè‰²å®šä¹‰
YELLOW := \033[1;33m
GREEN := \033[1;32m
RED := \033[1;31m
NC := \033[0m

help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "$(YELLOW)Available targets:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-12s$(NC) %s\n", $$1, $$2}'

install: ## å®‰è£…é¡¹ç›®ä¾èµ–å’Œå¼€å‘å·¥å…·
	@echo "$(YELLOW)Installing dependencies...$(NC)"
	pip install -U pip uv
	pip install -r requirements.txt
	pip install -e .
	pip install pre-commit ruff mypy pytest pytest-cov bandit
	@echo "$(GREEN)âœ… Dependencies installed$(NC)"

fmt: ## æ ¼å¼åŒ–ä»£ç  (ruff + black)
	@echo "$(YELLOW)Formatting code...$(NC)"
	ruff format .
	ruff check --fix .
	@echo "$(GREEN)âœ… Code formatted$(NC)"

lint: ## ä»£ç é£æ ¼æ£€æŸ¥ (ruff)
	@echo "$(YELLOW)Running linter...$(NC)"
	ruff check .
	@echo "$(GREEN)âœ… Linting passed$(NC)"

type: ## ç±»å‹æ£€æŸ¥ (mypy)
	@echo "$(YELLOW)Running type checker...$(NC)"
	mypy .
	@echo "$(GREEN)âœ… Type checking passed$(NC)"

test: ## è¿è¡Œæµ‹è¯• (pytest)
	@echo "$(YELLOW)Running tests...$(NC)"
	pytest -v
	@echo "$(GREEN)âœ… Tests passed$(NC)"

sec: ## å®‰å…¨æ£€æŸ¥ (bandit)
	@echo "$(YELLOW)Running security check...$(NC)"
	bandit -r . -f json -o bandit-report.json --exit-zero
	bandit -r . --configfile pyproject.toml
	@echo "$(GREEN)âœ… Security check passed$(NC)"

leaks: ## ç§˜å¯†æ³„éœ²æ£€æŸ¥ (gitleaks)
	@echo "$(YELLOW)Running secrets scan...$(NC)"
	@if command -v gitleaks >/dev/null 2>&1; then \
		gitleaks detect --config .gitleaks.toml --verbose --no-banner; \
		echo "$(GREEN)âœ… No secrets detected$(NC)"; \
	else \
		echo "$(RED)âš ï¸  gitleaks not installed, skipping...$(NC)"; \
	fi

ci: install fmt lint type sec test ## å®Œæ•´CIæ£€æŸ¥æµç¨‹
	@echo "$(GREEN)ğŸ‰ All CI checks passed!$(NC)"

clean: ## æ¸…ç†ç”Ÿæˆçš„æ–‡ä»¶
	@echo "$(YELLOW)Cleaning up...$(NC)"
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -exec rm -rf {} +
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	rm -rf .pytest_cache .mypy_cache .ruff_cache
	rm -rf htmlcov/ .coverage coverage.xml
	rm -f bandit-report.json
	@echo "$(GREEN)âœ… Cleanup complete$(NC)"
