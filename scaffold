#!/bin/bash
# ğŸ¯ è„šæ‰‹æ¶æ¨¡å—åŒ–ç³»ç»Ÿä¸»å…¥å£
# ç»Ÿä¸€çš„å‘½ä»¤è¡Œæ¥å£

set -euo pipefail

# è„šæœ¬é…ç½®
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ENHANCED_INSTALLER="${SCRIPT_DIR}/scaffold-modules/tools/enhanced-installer.sh"
MODULE_MANAGER="${SCRIPT_DIR}/scaffold-modules/tools/module-manager.py"

# é¢œè‰²è¾“å‡º
readonly GREEN='\033[0;32m'
readonly BLUE='\033[0;34m'
readonly YELLOW='\033[1;33m'
readonly NC='\033[0m'

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    echo -e "${BLUE}ğŸ¯ è„šæ‰‹æ¶æ¨¡å—åŒ–ç³»ç»Ÿ${NC}"
    echo ""
    echo "ç”¨æ³•: ./scaffold <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo "å¯ç”¨å‘½ä»¤:"
    echo ""
    echo -e "${GREEN}ğŸ“¦ æ¨¡å—ç®¡ç†:${NC}"
    echo "  install <modules...>     å®‰è£…æŒ‡å®šæ¨¡å—"
    echo "  uninstall <module>       å¸è½½æŒ‡å®šæ¨¡å—"
    echo "  list                     åˆ—å‡ºæ‰€æœ‰å¯ç”¨æ¨¡å—"
    echo "  status                   æ˜¾ç¤ºæ¨¡å—å®‰è£…çŠ¶æ€"
    echo "  upgrade [module]         å‡çº§æ¨¡å—ï¼ˆä¸æŒ‡å®šåˆ™å‡çº§å…¨éƒ¨ï¼‰"
    echo ""
    echo -e "${GREEN}ğŸšï¸ é¢„è®¾åŒ…:${NC}"
    echo "  preset <name>            å®‰è£…é¢„è®¾åŒ…"
    echo "                          å¯é€‰: minimal, professional, enterprise, ai-enhanced"
    echo ""
    echo -e "${GREEN}ğŸ”§ ç³»ç»Ÿç®¡ç†:${NC}"
    echo "  setup                    äº¤äº’å¼åˆå§‹åŒ–å‘å¯¼"
    echo "  health                   ç³»ç»Ÿå¥åº·æ£€æŸ¥"
    echo "  clean                    æ¸…ç†ä¸´æ—¶æ–‡ä»¶"
    echo "  backup                   å¤‡ä»½å½“å‰é…ç½®"
    echo ""
    echo -e "${GREEN}â„¹ï¸  ä¿¡æ¯:${NC}"
    echo "  help                     æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo "  version                  æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  ./scaffold setup                    # äº¤äº’å¼å®‰è£…"
    echo "  ./scaffold preset professional     # å®‰è£…ä¸“ä¸šç‰ˆ"
    echo "  ./scaffold install core cicd       # å®‰è£…ç‰¹å®šæ¨¡å—"
    echo "  ./scaffold list                     # æŸ¥çœ‹å¯ç”¨æ¨¡å—"
    echo "  ./scaffold status                   # æŸ¥çœ‹å®‰è£…çŠ¶æ€"
    echo ""
}

# æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
show_version() {
    echo -e "${BLUE}ğŸ¯ è„šæ‰‹æ¶æ¨¡å—åŒ–ç³»ç»Ÿ v2.1.0${NC}"
    echo ""
    echo "åŠŸèƒ½:"
    echo "  âœ¨ 8ä¸ªç‹¬ç«‹æ¨¡å—ï¼ŒæŒ‰éœ€å®‰è£…"
    echo "  ğŸ¤– æ™ºèƒ½ä¾èµ–ç®¡ç†å’Œå†²çªæ£€æµ‹"
    echo "  ğŸ“¦ 4ç§é¢„è®¾åŒ…ï¼Œå¼€ç®±å³ç”¨"
    echo "  ğŸ”„ ç‰ˆæœ¬æ§åˆ¶å’Œè‡ªåŠ¨å›æ»š"
    echo ""
}

# ä¸»å‡½æ•°
main() {
    case "${1:-}" in
        # æ¨¡å—ç®¡ç†
        install)
            shift
            if [[ $# -eq 0 ]]; then
                echo "é”™è¯¯: è¯·æŒ‡å®šè¦å®‰è£…çš„æ¨¡å—"
                echo "ç”¨æ³•: ./scaffold install <module1> [module2] ..."
                exit 1
            fi
            python3 "$MODULE_MANAGER" install "$@"
            ;;

        uninstall)
            if [[ $# -lt 2 ]]; then
                echo "é”™è¯¯: è¯·æŒ‡å®šè¦å¸è½½çš„æ¨¡å—"
                echo "ç”¨æ³•: ./scaffold uninstall <module>"
                exit 1
            fi
            python3 "$MODULE_MANAGER" uninstall "$2"
            ;;

        list)
            python3 "$MODULE_MANAGER" list
            ;;

        status)
            python3 "$MODULE_MANAGER" status
            ;;

        upgrade)
            if [[ $# -lt 2 ]]; then
                echo -e "${YELLOW}å‡çº§æ‰€æœ‰æ¨¡å—...${NC}"
                python3 "$MODULE_MANAGER" upgrade-all
            else
                python3 "$MODULE_MANAGER" upgrade "$2"
            fi
            ;;

        # é¢„è®¾åŒ…
        preset)
            if [[ $# -lt 2 ]]; then
                echo "é”™è¯¯: è¯·æŒ‡å®šé¢„è®¾åŒ…åç§°"
                echo "å¯ç”¨é¢„è®¾åŒ…: minimal, professional, enterprise, ai-enhanced"
                exit 1
            fi
            "$ENHANCED_INSTALLER" --preset "$2"
            ;;

        # ç³»ç»Ÿç®¡ç†
        setup)
            echo -e "${BLUE}ğŸš€ å¯åŠ¨äº¤äº’å¼å®‰è£…å‘å¯¼...${NC}"
            "$ENHANCED_INSTALLER" --interactive
            ;;

        health)
            echo -e "${BLUE}ğŸ” æ‰§è¡Œç³»ç»Ÿå¥åº·æ£€æŸ¥...${NC}"
            if [[ -f "scripts/health-check.py" ]]; then
                python3 scripts/health-check.py
            else
                echo "å¥åº·æ£€æŸ¥è„šæœ¬æœªæ‰¾åˆ°ï¼Œè¯·å…ˆå®‰è£…æ ¸å¿ƒæ¨¡å—"
            fi
            ;;

        clean)
            echo -e "${YELLOW}ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶...${NC}"
            rm -rf logs/*.log
            rm -rf reports/temp_*
            rm -rf __pycache__/ .pytest_cache/
            echo "âœ… æ¸…ç†å®Œæˆ"
            ;;

        backup)
            BACKUP_DIR="../scaffold-backup-$(date +%Y%m%d-%H%M%S)"
            echo -e "${YELLOW}ğŸ’¾ å¤‡ä»½å½“å‰é…ç½®åˆ° $BACKUP_DIR...${NC}"
            cp -r . "$BACKUP_DIR"
            echo "âœ… å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
            ;;

        # ä¿¡æ¯
        help|-h|--help)
            show_help
            ;;

        version|-v|--version)
            show_version
            ;;

        # é»˜è®¤
        "")
            echo -e "${BLUE}ğŸ¯ è„šæ‰‹æ¶æ¨¡å—åŒ–ç³»ç»Ÿ${NC}"
            echo ""
            echo "ä½¿ç”¨ './scaffold help' æŸ¥çœ‹å¯ç”¨å‘½ä»¤"
            echo "ä½¿ç”¨ './scaffold setup' å¼€å§‹äº¤äº’å¼å®‰è£…"
            echo ""
            ;;

        *)
            echo "é”™è¯¯: æœªçŸ¥å‘½ä»¤ '$1'"
            echo "ä½¿ç”¨ './scaffold help' æŸ¥çœ‹å¯ç”¨å‘½ä»¤"
            exit 1
            ;;
    esac
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
