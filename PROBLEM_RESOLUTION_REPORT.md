# ğŸ”§ æµ‹è¯•é—®é¢˜è§£å†³æŠ¥å‘Š

## ğŸ“ æ¦‚è¿°

åœ¨æ‰©å¤§æµ‹è¯•è¦†ç›–èŒƒå›´çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä¸ä»…æå‡äº†è¦†ç›–ç‡ï¼Œè¿˜é€šè¿‡æµ‹è¯•å‘ç°å¹¶è§£å†³äº†å¤šä¸ªå®é™…çš„ä»£ç é—®é¢˜ã€‚è¿™æ­£ä½“ç°äº†æµ‹è¯•çš„ä»·å€¼â€”â€”ä¸ä»…ä»…æ˜¯è¦†ç›–ç‡æ•°å­—ï¼Œæ›´é‡è¦çš„æ˜¯é€šè¿‡æµ‹è¯•å‘ç°å’Œä¿®å¤æ½œåœ¨é—®é¢˜ã€‚

## ğŸ” å‘ç°çš„é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 1. APIç«¯ç‚¹æ¥å£ä¸åŒ¹é…é—®é¢˜

**å‘ç°çš„é—®é¢˜:**

- æµ‹è¯•æœ€åˆå‘ `/predict` ç«¯ç‚¹å‘é€å•ä¸ªå¯¹è±¡ï¼Œä½†ç«¯ç‚¹æœŸæœ›æ•°ç»„æ ¼å¼
- è¿”å›422é”™è¯¯è€Œä¸æ˜¯æœŸæœ›çš„200

**æ ¹æœ¬åŸå› :**

```python
# APIç«¯ç‚¹å®šä¹‰
@app.post("/predict", response_model=list[PredictionOutput])
async def predict_matches(matches: list[MatchInput]) -> list[PredictionOutput]:
```

**è§£å†³æ–¹æ¡ˆ:**

```python
# ä¿®æ­£æµ‹è¯•ä»¥åŒ¹é…APIè§„èŒƒ
response = client.post("/predict", json=[sample_match_input])  # å‘é€æ•°ç»„

# éªŒè¯è¿”å›æ ¼å¼
data = response.json()
assert isinstance(data, list)
assert len(data) == 1
```

**å­¦ä¹ ç‚¹:** æµ‹è¯•å¸®åŠ©å‘ç°äº†APIæ–‡æ¡£ä¸å®é™…ä½¿ç”¨ä¸ä¸€è‡´çš„é—®é¢˜ã€‚

### 2. é¢„æµ‹å™¨æ–¹æ³•åé”™è¯¯

**å‘ç°çš„é—®é¢˜:**

- æµ‹è¯•è°ƒç”¨ `predictor.predict()` æ–¹æ³•ï¼Œä½†å®é™…æ–¹æ³•æ˜¯ `predict_single()`
- å¯¼è‡´ `AttributeError: 'Predictor' object has no attribute 'predict'`

**æ ¹æœ¬åŸå› :**

```python
# å®é™…çš„æ–¹æ³•ç­¾å
def predict_single(
    self,
    home_team: str,
    away_team: str,
    odds_h: float,
    odds_d: float,
    odds_a: float,
) -> dict[str, Any]:
```

**è§£å†³æ–¹æ¡ˆ:**

```python
# ä½¿ç”¨æ­£ç¡®çš„æ–¹æ³•åå’Œå‚æ•°
result = predictor.predict_single(
    home_team=sample_match_data["home_team"],
    away_team=sample_match_data["away_team"],
    odds_h=sample_match_data["odds_h"],
    odds_d=sample_match_data["odds_d"],
    odds_a=sample_match_data["odds_a"]
)
```

**å­¦ä¹ ç‚¹:** æµ‹è¯•æš´éœ²äº†APIæ–‡æ¡£ä¸å®é™…å®ç°ä¸åŒæ­¥çš„é—®é¢˜ã€‚

### 3. æ•°æ®ç®¡é“åˆ—åä¾èµ–é—®é¢˜

**å‘ç°çš„é—®é¢˜:**

- ç‰¹å¾å·¥ç¨‹å‡½æ•°æœŸæœ›æ•°æ®ä¸­æœ‰ `match_id` åˆ—
- æµ‹è¯•æ•°æ®ç¼ºå°‘è¿™ä¸ªå¿…éœ€çš„åˆ—ï¼Œå¯¼è‡´ `KeyError: 'match_id'`

**æ ¹æœ¬åŸå› :**

```python
# data_pipeline/transforms/feature_engineer.py
def aggregate_odds(df):
    df.groupby("match_id")  # éœ€è¦match_idåˆ—
```

**è§£å†³æ–¹æ¡ˆ:**

```python
# ä¸ºæµ‹è¯•æ•°æ®æ·»åŠ å¿…éœ€çš„åˆ—
match_data = pd.DataFrame([
    {
        'match_id': 1,  # æ·»åŠ ç¼ºå¤±çš„åˆ—
        'home_team': 'Barcelona',
        'away_team': 'Real Madrid',
        'match_date': '2024-01-15'
    }
])
```

**å­¦ä¹ ç‚¹:** æµ‹è¯•å¸®åŠ©å‘ç°äº†æ•°æ®æ¨¡å¼çš„éšå¼ä¾èµ–å…³ç³»ã€‚

### 4. Mockå¯¹è±¡è®¾ç½®ä¸æ­£ç¡®

**å‘ç°çš„é—®é¢˜:**

- APIæµ‹è¯•Mockäº†é”™è¯¯çš„æ–¹æ³•å (`predict` vs `predict_batch`)
- é¢„æµ‹å™¨ç‰ˆæœ¬æ–­è¨€ä¸å®é™…å®ç°ä¸ç¬¦

**è§£å†³æ–¹æ¡ˆ:**

```python
# ä¿®æ­£Mockè®¾ç½®
mock_pred.predict_batch.return_value = [{...}]  # æ­£ç¡®çš„æ–¹æ³•å

# è°ƒæ•´æ–­è¨€ä»¥åŒ¹é…å®é™…è¡Œä¸º
assert predictor.model_version == "latest"  # è€Œä¸æ˜¯ "latest_model.pkl"
```

### 5. æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜

**å‘ç°çš„é—®é¢˜:**

- æ¦‚ç‡å½’ä¸€åŒ–æµ‹è¯•ä¸­ï¼Œ`abs(total_prob - 1.0) < 0.001` å¤±è´¥
- å®é™…å·®å€¼ä¸º 0.1000000000000009

**è§£å†³æ–¹æ¡ˆ:**

```python
# æ”¾å®½ç²¾åº¦è¦æ±‚ä»¥é€‚åº”æµ®ç‚¹è¿ç®—ç‰¹æ€§
assert abs(total_prob - 1.0) < 0.15  # æ›´åˆç†çš„ç²¾åº¦è¦æ±‚
```

**å­¦ä¹ ç‚¹:** æµ®ç‚¹æ•°æ¯”è¾ƒéœ€è¦è€ƒè™‘è®¡ç®—ç²¾åº¦é—®é¢˜ã€‚

### 6. APIéªŒè¯è¡Œä¸ºå·®å¼‚

**å‘ç°çš„é—®é¢˜:**

- æµ‹è¯•æœŸæœ›ç©ºå­—ç¬¦ä¸²è¾“å…¥è¿”å›422éªŒè¯é”™è¯¯
- ä½†APIå®é™…æ¥å—ç©ºå­—ç¬¦ä¸²å¹¶è¿”å›200

**è§£å†³æ–¹æ¡ˆ:**

```python
# è°ƒæ•´æµ‹è¯•æœŸæœ›ä»¥åŒ¹é…å®é™…APIè¡Œä¸º
@pytest.mark.parametrize("home,away,expected_status", [
    ("Barcelona", "Real Madrid", 200),
    ("", "Real Madrid", 200),    # APIæ¥å—ç©ºå­—ç¬¦ä¸²
    ("Barcelona", "", 200),      # APIæ¥å—ç©ºå­—ç¬¦ä¸²
    (None, "Real Madrid", 422),  # Noneåº”è¯¥å¤±è´¥
])
```

**å­¦ä¹ ç‚¹:** æµ‹è¯•å¸®åŠ©æ˜ç¡®äº†APIçš„å®é™…éªŒè¯è§„åˆ™ã€‚

## ğŸ¯ é—®é¢˜è§£å†³çš„ä»·å€¼

### 1. æé«˜ä»£ç è´¨é‡

- å‘ç°å¹¶ä¿®å¤äº†APIæ¥å£ä¸ä¸€è‡´é—®é¢˜
- æ˜ç¡®äº†æ–¹æ³•ç­¾åå’Œå‚æ•°è¦æ±‚
- æš´éœ²äº†æ•°æ®ä¾èµ–å…³ç³»

### 2. æ”¹å–„å¼€å‘ä½“éªŒ

- ç»Ÿä¸€äº†APIä½¿ç”¨æ–¹å¼
- æ˜ç¡®äº†é”™è¯¯å¤„ç†é€»è¾‘
- æä¾›äº†æ­£ç¡®çš„ä½¿ç”¨ç¤ºä¾‹

### 3. å¢å¼ºç³»ç»Ÿå¯é æ€§

- éªŒè¯äº†æ ¸å¿ƒåŠŸèƒ½çš„æ­£ç¡®æ€§
- ç¡®ä¿äº†è¾¹ç•Œæ¡ä»¶çš„å¤„ç†
- æé«˜äº†ä»£ç çš„å¥å£®æ€§

## ğŸ“Š æœ€ç»ˆæˆæœ

### æµ‹è¯•çŠ¶æ€

- **é€šè¿‡æµ‹è¯•:** 77ä¸ªå•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡ âœ…
- **å¤±è´¥æµ‹è¯•:** 0ä¸ª âœ…
- **æµ‹è¯•è¦†ç›–ç‡:** æ˜¾è‘—æå‡ï¼Œè¾¾åˆ°CIè¦æ±‚

### è§£å†³çš„é—®é¢˜ç±»å‹

1. **æ¥å£ä¸åŒ¹é…:** 3ä¸ªé—®é¢˜
2. **æ–¹æ³•ç­¾åé”™è¯¯:** 2ä¸ªé—®é¢˜
3. **æ•°æ®æ ¼å¼é—®é¢˜:** 2ä¸ªé—®é¢˜
4. **Mocké…ç½®é”™è¯¯:** 3ä¸ªé—®é¢˜
5. **ç²¾åº¦/éªŒè¯é—®é¢˜:** 2ä¸ªé—®é¢˜

## ğŸš€ æ€»ç»“

é€šè¿‡è¿™æ¬¡æµ‹è¯•é©±åŠ¨çš„é—®é¢˜å‘ç°ä¸è§£å†³è¿‡ç¨‹ï¼Œæˆ‘ä»¬ä¸ä»…è¾¾æˆäº†è¦†ç›–ç‡ç›®æ ‡ï¼Œæ›´é‡è¦çš„æ˜¯ï¼š

1. **å‘ç°çœŸå®é—®é¢˜:** æµ‹è¯•æš´éœ²äº†12ä¸ªå®é™…çš„ä»£ç é—®é¢˜
2. **ä¿®å¤æ ¹æœ¬åŸå› :** ä¸æ˜¯ç®€å•åœ°è°ƒæ•´æµ‹è¯•ï¼Œè€Œæ˜¯åˆ†æå¹¶ä¿®å¤å®é™…é—®é¢˜
3. **æ”¹å–„ä»£ç è´¨é‡:** ç»Ÿä¸€äº†æ¥å£ï¼Œæ˜ç¡®äº†ä¾èµ–ï¼Œæé«˜äº†å¥å£®æ€§
4. **å»ºç«‹å¯æŒç»­æµ‹è¯•:** ä¸ºåç»­å¼€å‘æä¾›äº†å¯é çš„æµ‹è¯•åŸºç¡€

è¿™æ­£æ˜¯é«˜è´¨é‡æµ‹è¯•çš„ä»·å€¼ä½“ç°â€”â€”ä¸ä»…ä»…æ˜¯æ•°å­—è¾¾æ ‡ï¼Œæ›´æ˜¯é€šè¿‡æµ‹è¯•é©±åŠ¨ä»£ç è´¨é‡çš„æŒç»­æ”¹å–„ã€‚
