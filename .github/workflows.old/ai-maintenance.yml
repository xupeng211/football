# AI-Enhanced: é›†æˆçš„AIæ™ºèƒ½ç»´æŠ¤å·¥ä½œæµ
name: AI Smart Maintenance

on:
  # æ¯æ—¥è‡ªåŠ¨è¿è¡Œ
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©åˆå¤œUTC

  # æ‰‹åŠ¨è§¦å‘ - å¯é€‰æ‹©è¿è¡Œæ¨¡å¼
  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: true
        default: 'bug-report'
        type: choice
        options:
        - bug-report
        - create-fix-pr
        - full-maintenance
      bug_description:
        description: 'ä¿®å¤æ¨¡å¼: Bugæè¿°'
        required: false
        default: ''
      fix_patch:
        description: 'ä¿®å¤æ¨¡å¼: Base64ç¼–ç çš„è¡¥ä¸æ–‡ä»¶'
        required: false
        default: ''

jobs:
  # å¤œé—´BugæŠ¥å‘Šä»»åŠ¡
  nightly-bug-report:
    runs-on: ubuntu-latest
    if: github.event.schedule || inputs.mode == 'bug-report' || inputs.mode == 'full-maintenance'

    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install bandit safety

      - name: å®‰å…¨æ‰«æ
        run: |
          echo "ğŸ” æ‰§è¡Œå®‰å…¨æ‰«æ..."
          bandit -r . -f json -o security-report.json || true
          safety check --json --output safety-report.json || true

      - name: ç”Ÿæˆé—®é¢˜æŠ¥å‘Š
        run: |
          echo "ğŸ“‹ ç”Ÿæˆæ¯æ—¥ç»´æŠ¤æŠ¥å‘Š..."
          echo "## ğŸŒ™ æ¯æ—¥BugæŠ¥å‘Š - $(date)" > bug-report.md
          echo "### å®‰å…¨é—®é¢˜" >> bug-report.md
          if [ -f security-report.json ]; then
            echo "å‘ç°å®‰å…¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥security-report.json" >> bug-report.md
          else
            echo "âœ… æœªå‘ç°å®‰å…¨é—®é¢˜" >> bug-report.md
          fi

      - name: ä¸Šä¼ æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: daily-maintenance-report
          path: |
            bug-report.md
            security-report.json
            safety-report.json

  # AIä¿®å¤PRåˆ›å»ºä»»åŠ¡
  create-ai-fix-pr:
    runs-on: ubuntu-latest
    if: inputs.mode == 'create-fix-pr' || inputs.mode == 'full-maintenance'
    needs: [nightly-bug-report]

    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: åˆ›å»ºä¿®å¤åˆ†æ”¯
        run: |
          BRANCH_NAME="ai-fix-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $BRANCH_NAME
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: åº”ç”¨AIä¿®å¤
        if: inputs.fix_patch != ''
        run: |
          echo "ğŸ¤– åº”ç”¨AIç”Ÿæˆçš„ä¿®å¤..."
          echo "${{ inputs.fix_patch }}" | base64 -d > fix.patch
          git apply fix.patch || echo "è¡¥ä¸åº”ç”¨å¤±è´¥"

      - name: æäº¤ä¿®å¤
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "ğŸ¤– AIè‡ªåŠ¨ä¿®å¤: ${{ inputs.bug_description }}" || echo "æ— å˜æ›´éœ€è¦æäº¤"

      - name: æ¨é€å¹¶åˆ›å»ºPR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push origin $BRANCH_NAME
          gh pr create \
            --title "ğŸ¤– AIè‡ªåŠ¨ä¿®å¤: ${{ inputs.bug_description }}" \
            --body "æ­¤PRç”±AIè‡ªåŠ¨ç”Ÿæˆç”¨äºä¿®å¤é—®é¢˜: ${{ inputs.bug_description }}" \
            --label "ai-fix" \
            --assignee ${{ github.actor }}

  # ç»¼åˆç»´æŠ¤ä»»åŠ¡ï¼ˆä»…åœ¨full-maintenanceæ¨¡å¼è¿è¡Œï¼‰
  full-maintenance:
    runs-on: ubuntu-latest
    if: inputs.mode == 'full-maintenance'
    needs: [nightly-bug-report, create-ai-fix-pr]

    steps:
      - name: ç»¼åˆæŠ¥å‘Š
        run: |
          echo "ğŸ¯ AIæ™ºèƒ½ç»´æŠ¤å®Œæˆ"
          echo "- âœ… å¤œé—´Bugæ‰«æå®Œæˆ"
          echo "- âœ… AIä¿®å¤PRåˆ›å»ºå®Œæˆ"
          echo "è¯·æŸ¥çœ‹Actions artifactsè·å–è¯¦ç»†æŠ¥å‘Š"
