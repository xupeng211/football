# 🚀 Lightweight CI - 快速验证工作流
name: Lightweight-CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

env:
  PYTHON_VERSION: "3.11"
  DATABASE_URL: "sqlite:///./test.db"
  ENVIRONMENT: "testing"
  CI: "true"

jobs:
  fast-validation:
    name: 🚀 Fast Code Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install uv and dependencies
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          uv sync --extra dev
          
      - name: ✅ Run CI Checks (本地=CI一致)
        run: |
          echo "🚀 运行CI级别检查 (与本地make ci-check完全一致)..."
          make ci-check
          
      - name: ✅ Basic Module Import Test
        run: |
          echo "📦 测试核心模块导入..."
          uv run python -c "
          import sys
          sys.path.insert(0, 'src')
          
          from football_predict_system.core.config import get_settings
          from football_predict_system.domain.models import Team, Match
          print('✅ 核心模块导入成功')
          "
          
      - name: ✅ SQLite Database Test
        run: |
          echo "🗄️ 测试SQLite数据库功能..."
          uv run python -c "
          import sys
          sys.path.insert(0, 'src')
          
          from football_predict_system.core.database import get_database_manager
          from football_predict_system.core.config import get_settings
          
          settings = get_settings()
          print(f'使用数据库: {settings.get_database_url()}')
          
          # 基础数据库管理器测试
          db_manager = get_database_manager()
          print('✅ 数据库管理器初始化成功')
          "

  validation-summary:
    name: 📋 Validation Summary
    runs-on: ubuntu-latest
    needs: [fast-validation]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "🏆 LIGHTWEIGHT CI SUMMARY"
          echo "========================="
          echo "📅 时间: $(date)"
          echo "🚀 快速验证: ${{ needs.fast-validation.result }}"
          
          if [[ "${{ needs.fast-validation.result }}" == "success" ]]; then
            echo "✅ 代码质量验证通过！"
            echo "🎯 基础功能正常"
            echo "🚀 可以安全继续开发"
          else
            echo "❌ 验证失败，请检查代码"
            exit 1
          fi 