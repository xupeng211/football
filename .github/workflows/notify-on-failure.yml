name: Notify on CI Failure

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  notify-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const workflow = context.payload.workflow_run;
            const title = `ðŸš¨ CI Failure: ${workflow.head_branch}`;
            const body = `
            ## ðŸš¨ CIæž„å»ºå¤±è´¥æŠ¥å‘Š
            
            **å·¥ä½œæµ**: ${workflow.name}
            **åˆ†æ”¯**: ${workflow.head_branch}
            **æäº¤**: ${workflow.head_sha.substring(0, 7)}
            **æ—¶é—´**: ${new Date(workflow.created_at).toLocaleString()}
            **è¿è¡ŒID**: ${workflow.id}
            
            ### ðŸ”— é“¾æŽ¥
            - [æŸ¥çœ‹å¤±è´¥çš„è¿è¡Œ](${workflow.html_url})
            - [æŸ¥çœ‹æäº¤](https://github.com/${context.repo.owner}/${context.repo.repo}/commit/${workflow.head_sha})
            
            ### âš¡ å¿«é€Ÿä¿®å¤å»ºè®®
            
            å¸¸è§CIå¤±è´¥åŽŸå› ï¼š
            1. **æµ‹è¯•å¤±è´¥** - æ£€æŸ¥æµ‹è¯•ç”¨ä¾‹å’Œä»£ç å˜æ›´
            2. **Lintingé”™è¯¯** - è¿è¡Œ \`make lint\` ä¿®å¤ä»£ç é£Žæ ¼
            3. **ç±»åž‹æ£€æŸ¥** - è¿è¡Œ \`make type\` ä¿®å¤ç±»åž‹é—®é¢˜
            4. **ä¾èµ–é—®é¢˜** - æ£€æŸ¥ requirements.txt å’ŒçŽ¯å¢ƒé…ç½®
            
            ### ðŸ› ï¸ æœ¬åœ°è°ƒè¯•å‘½ä»¤
            
            \`\`\`bash
            # æ¿€æ´»çŽ¯å¢ƒå¹¶è¿è¡Œå®Œæ•´æ£€æŸ¥
            source scripts/activate-venv.sh
            make ci
            
            # ç”Ÿæˆæµ‹è¯•æŠ¥å‘ŠæŸ¥çœ‹è¯¦æƒ…
            python scripts/automated_test_report.py
            \`\`\`
            
            ---
            *æ­¤Issueç”±CIç›‘æŽ§è‡ªåŠ¨åˆ›å»º - ${new Date().toISOString()}*
            `;
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„failure issue
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure,automated'
            });
            
            const sameWorkflowIssue = existingIssues.data.find(issue => 
              issue.title.includes(workflow.head_branch) && 
              issue.title.includes('CI Failure')
            );
            
            if (!sameWorkflowIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['ci-failure', 'automated', 'bug']
              });
            }

      - name: Send notification comment
        uses: actions/github-script@v7
        if: github.event.workflow_run.event == 'pull_request'
        with:
          script: |
            const workflow = context.payload.workflow_run;
            const comment = `
            ## ðŸš¨ CIæ£€æŸ¥å¤±è´¥
            
            @${workflow.head_commit.author.name} æ‚¨çš„PRè§¦å‘äº†CIå¤±è´¥ã€‚
            
            **å¤±è´¥å·¥ä½œæµ**: ${workflow.name}
            **è¿è¡Œé“¾æŽ¥**: [æŸ¥çœ‹è¯¦æƒ…](${workflow.html_url})
            
            è¯·æ£€æŸ¥å¹¶ä¿®å¤é—®é¢˜åŽé‡æ–°æäº¤ã€‚å¸¸ç”¨è°ƒè¯•å‘½ä»¤ï¼š
            \`\`\`bash
            source scripts/activate-venv.sh
            make ci
            \`\`\`
            `;
            
            // èŽ·å–ç›¸å…³çš„PR
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: \`\${context.repo.owner}:\${workflow.head_branch}\`,
              state: 'open'
            });
            
            if (prs.data.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prs.data[0].number,
                body: comment
              });
            } 