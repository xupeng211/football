# ğŸ›¡ï¸ Comprehensive CI Pipeline - ä¸¥æ ¼è´¨é‡é—¨ç¦
name: Comprehensive-CI

on:
  push:
    branches: [main, dev, refactor-v3]
  pull_request:
    branches: [main, dev]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"
  # æµ‹è¯•ç¯å¢ƒé…ç½®
  DATABASE_URL: "postgresql://test_user:test_pass@localhost:5432/test_football_db"
  REDIS_URL: "redis://localhost:6379/1"
  FOOTBALL_DATA_API_KEY: "test_api_key"
  ENVIRONMENT: "testing"

jobs:
  # =================== ç¬¬ä¸€å±‚: ä»£ç è´¨é‡é—¨ç¦ ===================
  code-quality:
    name: ğŸ¨ Code Quality Gate
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
      - name: Install dependencies
        run: |
          uv sync --extra dev
          
      - name: âŒ STRICT Format Check
        run: |
          echo "ğŸ¨ æ£€æŸ¥ä»£ç æ ¼å¼..."
          uv run ruff format --check .
          echo "âœ… ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"
          
      - name: âŒ STRICT Lint Check  
        run: |
          echo "ğŸ” æ‰§è¡Œä»£ç æ£€æŸ¥..."
          uv run ruff check src/ --output-format=github
          echo "ğŸ” æ£€æŸ¥æµ‹è¯•æ–‡ä»¶å…³é”®é”™è¯¯..."
          uv run ruff check tests/ --select=E,F,B --ignore=E402 --output-format=github
          echo "âœ… ä»£ç æ£€æŸ¥é€šè¿‡"
          
      - name: âŒ STRICT Type Check (Data Platform Focus)
        run: |
          echo "ğŸ”¬ æ‰§è¡Œç±»å‹æ£€æŸ¥..."
          echo "ğŸ“Š æ£€æŸ¥æ•°æ®å¹³å°æ¨¡å— (æ ¸å¿ƒåŠŸèƒ½)..."
          uv run mypy src/football_predict_system/data_platform/ --show-error-codes --no-error-summary --ignore-missing-imports
          echo "âœ… æ•°æ®å¹³å°ç±»å‹æ£€æŸ¥é€šè¿‡"
          
      - name: âŒ STRICT Security Check
        run: |
          echo "ğŸ›¡ï¸ æ‰§è¡Œå®‰å…¨æ‰«æ..."
          uv run bandit -r src/ -c pyproject.toml
          echo "âœ… å®‰å…¨æ£€æŸ¥é€šè¿‡"

  # =================== ç¬¬äºŒå±‚: åŸºç¡€åŠŸèƒ½é—¨ç¦ ===================
  basic-functionality:
    name: ğŸ§ª Basic Functionality Gate
    runs-on: ubuntu-latest
    needs: code-quality
    timeout-minutes: 15
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
          POSTGRES_DB: test_football_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install uv and dependencies
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          uv sync --extra dev
          
      - name: âŒ STRICT Module Import Test
        run: |
          echo "ğŸ“¦ æµ‹è¯•æ¨¡å—å¯¼å…¥..."
          uv run python -c "
          import sys
          sys.path.insert(0, 'src')
          
          # æµ‹è¯•æ ¸å¿ƒæ¨¡å—
          from football_predict_system.core.config import get_settings
          from football_predict_system.core.database import get_database_manager
          from football_predict_system.domain.models import Match, Team
          print('âœ… æ ¸å¿ƒæ¨¡å—å¯¼å…¥æˆåŠŸ')
          
          # æµ‹è¯•æ•°æ®å¹³å°æ¨¡å—
          from football_predict_system.data_platform.sources.base import DataSource
          from football_predict_system.data_platform.sources.football_data_api import FootballDataAPICollector
          from football_predict_system.data_platform.storage.database_writer import DatabaseWriter
          from football_predict_system.data_platform.config import get_data_platform_config
          print('âœ… æ•°æ®å¹³å°æ¨¡å—å¯¼å…¥æˆåŠŸ')
          
          # æµ‹è¯•æµç¨‹æ¨¡å—
          from football_predict_system.data_platform.flows.data_collection import daily_data_collection_flow
          print('âœ… æµç¨‹æ¨¡å—å¯¼å…¥æˆåŠŸ')
          "
          
      - name: âŒ STRICT Database Schema Test
        run: |
          echo "ğŸ—„ï¸ æµ‹è¯•æ•°æ®åº“Schema..."
          # éªŒè¯SQLè¯­æ³•
          uv run python -c "
          import sqlparse
          with open('sql/schema.sql', 'r') as f:
              schema = f.read()
          
          statements = sqlparse.split(schema)
          print(f'è§£æåˆ° {len(statements)} æ¡SQLè¯­å¥')
          
          for i, stmt in enumerate(statements[:5]):  # æ£€æŸ¥å‰5æ¡
              if stmt.strip():
                  parsed = sqlparse.parse(stmt)[0]
                  print(f'SQL {i+1}: è¯­æ³•æ­£ç¡®')
          
          print('âœ… SQL Schemaè¯­æ³•éªŒè¯é€šè¿‡')
          "
          
          # å®é™…æ‰§è¡ŒSchema
          uv run python scripts/data_platform/setup_data_platform.py --action setup
          echo "âœ… æ•°æ®åº“Schemaåˆ›å»ºæˆåŠŸ"
          
      - name: âŒ STRICT Configuration Test
        run: |
          echo "âš™ï¸ æµ‹è¯•é…ç½®ç³»ç»Ÿ..."
          uv run python -c "
          import sys
          sys.path.insert(0, 'src')
          
          from football_predict_system.data_platform.config import get_data_platform_config
          config = get_data_platform_config()
          
          assert config.football_data_org.rate_limit_per_minute > 0
          assert len(config.schedule.daily_competitions) > 0
          assert config.schedule.daily_collection_cron
          
          print('âœ… é…ç½®ç³»ç»ŸéªŒè¯é€šè¿‡')
          "

  # =================== ç¬¬ä¸‰å±‚: æ ¸å¿ƒåŠŸèƒ½é›†æˆæµ‹è¯• ===================
  integration-tests:
    name: ğŸ”— Integration Test Gate  
    runs-on: ubuntu-latest
    needs: basic-functionality
    timeout-minutes: 20
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
          POSTGRES_DB: test_football_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python and dependencies
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install uv and dependencies
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          uv sync --extra dev
          
      - name: Setup test environment
        run: |
          echo "ğŸ—ï¸ è®¾ç½®æµ‹è¯•ç¯å¢ƒ..."
          uv run python scripts/data_platform/setup_data_platform.py --action setup
          echo "âœ… æµ‹è¯•ç¯å¢ƒå‡†å¤‡å®Œæˆ"
          
      - name: âŒ STRICT Database Writer Test
        run: |
          echo "ğŸ—„ï¸ æµ‹è¯•æ•°æ®åº“å†™å…¥åŠŸèƒ½..."
          uv run python -c "
          import sys, asyncio
          sys.path.insert(0, 'src')
          
          async def test_database_writer():
              from football_predict_system.data_platform.storage.database_writer import DatabaseWriter
              from football_predict_system.domain.models import Team, Match
              
              writer = DatabaseWriter()
              
              # æµ‹è¯•å›¢é˜Ÿå†™å…¥
              test_teams = [
                  Team(external_api_id=1, name='Test Team 1', short_name='TT1', tla='TT1'),
                  Team(external_api_id=2, name='Test Team 2', short_name='TT2', tla='TT2')
              ]
              
              result = await writer.upsert_teams(test_teams)
              assert result.records_processed == len(test_teams), f'Expected {len(test_teams)}, got {result.records_processed}'
              
              print('âœ… æ•°æ®åº“å†™å…¥æµ‹è¯•é€šè¿‡')
              
          asyncio.run(test_database_writer())
          "
          
      - name: âŒ STRICT Data Validation Test
        run: |
          echo "âœ… æµ‹è¯•æ•°æ®éªŒè¯é€»è¾‘..."
          uv run python -c "
          import sys, pandas as pd
          sys.path.insert(0, 'src')
          
          from football_predict_system.data_platform.sources.football_data_api import FootballDataAPICollector
          
          collector = FootballDataAPICollector(api_key='test_key')
          
          # æµ‹è¯•æœ‰æ•ˆæ•°æ®
          valid_data = pd.DataFrame({
              'external_api_id': [1, 2],
              'home_team': ['Team A', 'Team B'],
              'away_team': ['Team C', 'Team D'],
              'match_date': ['2024-01-01', '2024-01-02'],
              'home_score': [2, 1],
              'away_score': [1, 0],
              'status': ['finished', 'finished']
          })
          
          assert collector.validate(valid_data) == True, 'æœ‰æ•ˆæ•°æ®éªŒè¯å¤±è´¥'
          
          # æµ‹è¯•æ— æ•ˆæ•°æ®
          invalid_data = pd.DataFrame({'external_api_id': [1]})
          assert collector.validate(invalid_data) == False, 'æ— æ•ˆæ•°æ®åº”è¯¥è¢«æ‹’ç»'
          
          print('âœ… æ•°æ®éªŒè¯é€»è¾‘æµ‹è¯•é€šè¿‡')
          "
          
      - name: âŒ STRICT Flow Definition Test
        run: |
          echo "ğŸ”„ æµ‹è¯•Prefectæµç¨‹å®šä¹‰..."
          uv run python -c "
          import sys, asyncio
          sys.path.insert(0, 'src')
          
          async def test_flows():
              # æµ‹è¯•æµç¨‹å¯ä»¥è¢«å¯¼å…¥å’Œå®šä¹‰
              from football_predict_system.data_platform.flows.data_collection import (
                  daily_data_collection_flow,
                  historical_backfill_flow,
                  data_quality_check_flow
              )
              
              # éªŒè¯æµç¨‹ç­¾å
              import inspect
              
              # æ£€æŸ¥daily_data_collection_flow
              sig = inspect.signature(daily_data_collection_flow)
              assert len(sig.parameters) == 0, 'daily_data_collection_flowåº”è¯¥æ— å‚æ•°'
              
              # æ£€æŸ¥historical_backfill_flow  
              sig = inspect.signature(historical_backfill_flow)
              expected_params = {'competition_id', 'start_date', 'end_date'}
              actual_params = set(sig.parameters.keys())
              assert expected_params.issubset(actual_params), f'ç¼ºå°‘å‚æ•°: {expected_params - actual_params}'
              
              print('âœ… Prefectæµç¨‹å®šä¹‰æµ‹è¯•é€šè¿‡')
              
          asyncio.run(test_flows())
          "

  # =================== ç¬¬å››å±‚: æ•°æ®å¹³å°åŠŸèƒ½é—¨ç¦ ===================  
  data-platform-tests:
    name: ğŸ“Š Data Platform Functionality Gate
    runs-on: ubuntu-latest
    needs: integration-tests
    timeout-minutes: 25
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
          POSTGRES_DB: test_football_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python and dependencies
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install uv and dependencies
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          uv sync --extra dev
          
      - name: Setup test environment
        run: |
          uv run python scripts/data_platform/setup_data_platform.py --action setup
          
      - name: âŒ STRICT Mock API Response Test
        run: |
          echo "ğŸ“¡ æµ‹è¯•APIå“åº”å¤„ç†..."
          uv run python -c "
          import sys, asyncio, json
          sys.path.insert(0, 'src')
          
          async def test_api_response_handling():
              from football_predict_system.data_platform.sources.football_data_api import FootballDataAPICollector
              
              collector = FootballDataAPICollector(api_key='test_key')
              
              # æ¨¡æ‹ŸAPIå“åº”æ•°æ®
              mock_matches_response = {
                  'matches': [
                      {
                          'id': 1,
                          'homeTeam': {'id': 1, 'name': 'Liverpool', 'shortName': 'LIV', 'tla': 'LIV'},
                          'awayTeam': {'id': 2, 'name': 'Arsenal', 'shortName': 'ARS', 'tla': 'ARS'},
                          'utcDate': '2024-01-01T15:00:00Z',
                          'score': {'fullTime': {'home': 2, 'away': 1}},
                          'status': 'FINISHED'
                      }
                  ]
              }
              
              # æµ‹è¯•æ•°æ®è§£æ
              matches_df = collector._parse_matches_response(mock_matches_response)
              assert len(matches_df) == 1, 'åº”è¯¥è§£æå‡º1åœºæ¯”èµ›'
              assert matches_df.iloc[0]['home_score'] == 2, 'ä¸»é˜Ÿå¾—åˆ†åº”è¯¥æ˜¯2'
              assert matches_df.iloc[0]['away_score'] == 1, 'å®¢é˜Ÿå¾—åˆ†åº”è¯¥æ˜¯1'
              
              print('âœ… APIå“åº”å¤„ç†æµ‹è¯•é€šè¿‡')
              
          asyncio.run(test_api_response_handling())
          "
          
      - name: âŒ STRICT End-to-End Simulation Test
        run: |
          echo "ğŸ¯ ç«¯åˆ°ç«¯æ¨¡æ‹Ÿæµ‹è¯•..."
          uv run python -c "
          import sys, asyncio, pandas as pd
          from datetime import datetime
          sys.path.insert(0, 'src')
          
          async def test_end_to_end():
              from football_predict_system.data_platform.storage.database_writer import DatabaseWriter
              from football_predict_system.domain.models import Team, Match
              
              writer = DatabaseWriter()
              
              # 1. æµ‹è¯•å®Œæ•´çš„æ•°æ®å†™å…¥æµç¨‹
              test_teams = [
                  Team(external_api_id=100, name='Test Team A', short_name='TTA', tla='TTA'),
                  Team(external_api_id=101, name='Test Team B', short_name='TTB', tla='TTB')
              ]
              
              team_result = await writer.upsert_teams(test_teams)
              assert team_result.records_processed == 2, 'å›¢é˜Ÿå†™å…¥å¤±è´¥'
              
              # 2. æµ‹è¯•æ•°æ®è´¨é‡ç»Ÿè®¡
              stats = await writer.get_data_quality_stats()
              assert 'total_matches' in stats, 'æ•°æ®è´¨é‡ç»Ÿè®¡ç¼ºå°‘total_matches'
              assert 'teams_count' in stats, 'æ•°æ®è´¨é‡ç»Ÿè®¡ç¼ºå°‘teams_count'
              
              # 3. æµ‹è¯•é‡‡é›†æ—¥å¿—è®°å½•
              from football_predict_system.data_platform.sources.base import CollectionStats
              collection_stats = CollectionStats(
                  started_at=datetime.utcnow(),
                  records_fetched=10,
                  records_processed=8
              )
              
              await writer.log_collection_run('test_source', collection_stats)
              print('âœ… é‡‡é›†æ—¥å¿—è®°å½•æˆåŠŸ')
              
              print('âœ… ç«¯åˆ°ç«¯æ¨¡æ‹Ÿæµ‹è¯•é€šè¿‡')
              
          asyncio.run(test_end_to_end())
          "
          
      - name: âŒ STRICT Data Platform Health Check
        run: |
          echo "ğŸ¥ æ•°æ®å¹³å°å¥åº·æ£€æŸ¥..."
          uv run python scripts/data_platform/setup_data_platform.py --action health
          echo "âœ… æ•°æ®å¹³å°å¥åº·æ£€æŸ¥é€šè¿‡"

  # =================== ç¬¬äº”å±‚: ç”Ÿäº§å°±ç»ªéªŒè¯ ===================
  production-readiness:
    name: ğŸ­ Production Readiness Gate
    runs-on: ubuntu-latest  
    needs: data-platform-tests
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python and dependencies
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install uv and dependencies
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          uv sync --extra dev
          
      - name: âŒ STRICT Production Config Validation
        run: |
          echo "ğŸ”§ éªŒè¯ç”Ÿäº§é…ç½®æ¨¡æ¿..."
          
          # æ£€æŸ¥ç”Ÿäº§é…ç½®æ¨¡æ¿å­˜åœ¨
          test -f config/production.env.template || (echo "âŒ ç”Ÿäº§é…ç½®æ¨¡æ¿ç¼ºå¤±" && exit 1)
          
          # æ£€æŸ¥ç›‘æ§é…ç½®å­˜åœ¨
          test -f monitoring/prometheus/football_data_platform.yml || (echo "âŒ Prometheusé…ç½®ç¼ºå¤±" && exit 1)
          test -f monitoring/grafana/dashboards/data_platform_dashboard.json || (echo "âŒ Grafanaé¢æ¿ç¼ºå¤±" && exit 1)
          
          # æ£€æŸ¥ç”Ÿäº§è„šæœ¬å­˜åœ¨ä¸”å¯æ‰§è¡Œ
          test -x scripts/production/quick_production_setup.sh || (echo "âŒ ç”Ÿäº§è®¾ç½®è„šæœ¬ä¸å¯æ‰§è¡Œ" && exit 1)
          test -f scripts/production/production_checklist.py || (echo "âŒ ç”Ÿäº§æ£€æŸ¥è„šæœ¬ç¼ºå¤±" && exit 1)
          
          echo "âœ… ç”Ÿäº§é…ç½®éªŒè¯é€šè¿‡"
          
      - name: âŒ STRICT Documentation Check
        run: |
          echo "ğŸ“š æ£€æŸ¥æ–‡æ¡£å®Œæ•´æ€§..."
          
          # æ£€æŸ¥æ ¸å¿ƒæ–‡æ¡£å­˜åœ¨
          test -f README.md || (echo "âŒ README.mdç¼ºå¤±" && exit 1)
          test -f docs/DATA_PLATFORM_GUIDE.md || (echo "âŒ æ•°æ®å¹³å°æ–‡æ¡£ç¼ºå¤±" && exit 1)
          
          # æ£€æŸ¥MakefileåŒ…å«æ•°æ®å¹³å°å‘½ä»¤
          grep -q "data-setup" Makefile || (echo "âŒ Makefileç¼ºå°‘data-setupå‘½ä»¤" && exit 1)
          grep -q "data-collect" Makefile || (echo "âŒ Makefileç¼ºå°‘data-collectå‘½ä»¤" && exit 1)
          grep -q "data-monitor" Makefile || (echo "âŒ Makefileç¼ºå°‘data-monitorå‘½ä»¤" && exit 1)
          
          echo "âœ… æ–‡æ¡£å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡"

  # =================== æœ€ç»ˆæŠ¥å‘Š ===================
  comprehensive-summary:
    name: ğŸ“‹ Comprehensive Quality Report
    runs-on: ubuntu-latest
    needs: [code-quality, basic-functionality, integration-tests, production-readiness]
    if: always()
    
    steps:
      - name: Generate Quality Report
        run: |
          echo "ğŸ† COMPREHENSIVE CI QUALITY REPORT"
          echo "=========================================="
          echo "ğŸ“… æ„å»ºæ—¶é—´: $(date)"
          echo "ğŸ”§ ä»£ç è´¨é‡é—¨ç¦: ${{ needs.code-quality.result }}"
          echo "ğŸ§ª åŸºç¡€åŠŸèƒ½é—¨ç¦: ${{ needs.basic-functionality.result }}"  
          echo "ğŸ”— é›†æˆæµ‹è¯•é—¨ç¦: ${{ needs.integration-tests.result }}"
          echo "ğŸ­ ç”Ÿäº§å°±ç»ªé—¨ç¦: ${{ needs.production-readiness.result }}"
          echo
          
          # åˆ¤æ–­æ•´ä½“ç»“æœ
          if [[ "${{ needs.code-quality.result }}" == "success" ]] && \
             [[ "${{ needs.basic-functionality.result }}" == "success" ]] && \
             [[ "${{ needs.integration-tests.result }}" == "success" ]] && \
             [[ "${{ needs.production-readiness.result }}" == "success" ]]; then
            echo "ğŸ‰ å…¨éƒ¨è´¨é‡é—¨ç¦é€šè¿‡ï¼"
            echo "âœ… åŠŸèƒ½å®Œæ•´æ€§å¾—åˆ°ä¸¥æ ¼éªŒè¯"
            echo "ğŸš€ ä»£ç å¯ä»¥å®‰å…¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
            echo
            echo "ğŸ¯ è´¨é‡ä¿è¯çº§åˆ«: ENTERPRISE GRADE â­â­â­â­â­"
          else
            echo "âš ï¸ éƒ¨åˆ†è´¨é‡é—¨ç¦æœªé€šè¿‡"
            echo "ğŸ” è¯·æ£€æŸ¥å¤±è´¥çš„é—¨ç¦å¹¶ä¿®å¤é—®é¢˜"
            echo "âŒ ä¸å»ºè®®éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
            echo
            echo "ğŸ¯ è´¨é‡ä¿è¯çº§åˆ«: NEEDS IMPROVEMENT â­â­"
            exit 1
          fi 