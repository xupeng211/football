name: Coverage Alert

on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches: [main]

jobs:
  coverage-check:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: football_test
          POSTGRES_USER: football
          POSTGRES_PASSWORD: football
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥æ¯”è¾ƒè¦†ç›–ç‡

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          python -m pip install -U pip uv
          uv pip sync requirements.lock
          uv pip install -e .

      - name: Install psql client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Initialize DB Schema
        env:
          PGPASSWORD: football
        run: psql -h localhost -U football -d football_test -f sql/schema.sql

      - name: Run tests with coverage
        env:
          DATABASE_URL: postgresql://football:football@localhost:5432/football_test
        run: |
          pytest tests/unit/ tests/integration/ tests/performance/ \
            --cov=. \
            --cov-report=json:coverage-current.json \
            --cov-report=term \
            || echo "Some tests failed, but continuing coverage check"

      - name: Check coverage and create alert
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // è¯»å–å½“å‰è¦†ç›–ç‡
            let currentCoverage = 0;
            try {
              const coverageData = JSON.parse(fs.readFileSync('coverage-current.json', 'utf8'));
              currentCoverage = coverageData.totals.percent_covered;
            } catch (error) {
              console.log('æ— æ³•è¯»å–è¦†ç›–ç‡æ•°æ®:', error.message);
              return;
            }

            // è®¾ç½®è¦†ç›–ç‡é˜ˆå€¼
            const TARGET_COVERAGE = 80;
            const WARNING_THRESHOLD = 75;

            console.log(`å½“å‰è¦†ç›–ç‡: ${currentCoverage.toFixed(2)}%`);
            console.log(`ç›®æ ‡è¦†ç›–ç‡: ${TARGET_COVERAGE}%`);

            // ç”Ÿæˆè¦†ç›–ç‡çŠ¶æ€æ¶ˆæ¯
            let coverageStatus = '';
            let alertLevel = '';
            let emoji = '';

            if (currentCoverage >= TARGET_COVERAGE) {
              coverageStatus = 'ä¼˜ç§€';
              alertLevel = 'success';
              emoji = 'ğŸ‰';
            } else if (currentCoverage >= WARNING_THRESHOLD) {
              coverageStatus = 'è‰¯å¥½';
              alertLevel = 'warning';
              emoji = 'âš ï¸';
            } else {
              coverageStatus = 'éœ€è¦æ”¹è¿›';
              alertLevel = 'error';
              emoji = 'ğŸš¨';
            }

            // å¦‚æœæ˜¯PRï¼Œæ·»åŠ è¯„è®º
            if (context.eventName === 'pull_request') {
              const comment = `
              ## ${emoji} æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š

              **å½“å‰è¦†ç›–ç‡**: ${currentCoverage.toFixed(2)}%
              **ç›®æ ‡è¦†ç›–ç‡**: ${TARGET_COVERAGE}%
              **çŠ¶æ€**: ${coverageStatus}

              ### ğŸ“Š è¦†ç›–ç‡è¯„ä¼°

              ${currentCoverage >= TARGET_COVERAGE ?
                'âœ… **ä¼˜ç§€!** è¦†ç›–ç‡è¾¾åˆ°ä¼ä¸šçº§æ ‡å‡†' :
                currentCoverage >= WARNING_THRESHOLD ?
                'âš ï¸ **æ³¨æ„** è¦†ç›–ç‡æ¥è¿‘è­¦æˆ’çº¿ï¼Œå»ºè®®å¢åŠ æµ‹è¯•' :
                'ğŸš¨ **è­¦å‘Š** è¦†ç›–ç‡ä½äºæ ‡å‡†ï¼Œè¯·æ·»åŠ æ›´å¤šæµ‹è¯•ç”¨ä¾‹'
              }

              ### ğŸ¯ æ¨èè¡ŒåŠ¨

              ${currentCoverage < TARGET_COVERAGE ? `
              - è¿è¡Œ \`python scripts/automated_test_report.py\` æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š
              - æ·»åŠ æµ‹è¯•ç”¨ä¾‹è¦†ç›–æœªæµ‹è¯•çš„ä»£ç 
              - é‡ç‚¹å…³æ³¨è¦†ç›–ç‡è¾ƒä½çš„æ¨¡å—
              ` : `
              - ä¿æŒå½“å‰çš„é«˜è´¨é‡æµ‹è¯•æ ‡å‡†
              - ç»§ç»­ä¸ºæ–°åŠŸèƒ½æ·»åŠ ç›¸åº”æµ‹è¯•
              `}

              ### ğŸ”— ç›¸å…³é“¾æ¥

              - [æŸ¥çœ‹å®Œæ•´æµ‹è¯•æŠ¥å‘Š](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              - [æµ‹è¯•æŒ‡å—](https://github.com/${context.repo.owner}/${context.repo.repo}#quality-assurance)

              ---
              *è¦†ç›–ç‡ç›‘æ§ç”±è‡ªåŠ¨åŒ–ç³»ç»Ÿç”Ÿæˆ â€¢ ${new Date().toLocaleString()}*
              `;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

            // å¦‚æœè¦†ç›–ç‡ä¸¥é‡ä¸‹é™ï¼Œåˆ›å»ºIssue
            if (currentCoverage < WARNING_THRESHOLD && context.eventName === 'push') {
              const issueTitle = `ğŸš¨ æµ‹è¯•è¦†ç›–ç‡è­¦å‘Š: ${currentCoverage.toFixed(2)}%`;
              const issueBody = `
              ## ğŸš¨ æµ‹è¯•è¦†ç›–ç‡ä½äºè­¦æˆ’çº¿

              **å½“å‰è¦†ç›–ç‡**: ${currentCoverage.toFixed(2)}%
              **è­¦æˆ’çº¿**: ${WARNING_THRESHOLD}%
              **ç›®æ ‡**: ${TARGET_COVERAGE}%
              **åˆ†æ”¯**: ${context.ref.replace('refs/heads/', '')}
              **æäº¤**: ${context.sha.substring(0, 7)}

              ### ğŸ“‰ è¦†ç›–ç‡ä¸‹é™åŸå› 

              å¯èƒ½çš„åŸå› åŒ…æ‹¬ï¼š
              1. æ–°å¢ä»£ç æœªåŒ…å«ç›¸åº”æµ‹è¯•
              2. ç°æœ‰æµ‹è¯•è¢«æ„å¤–åˆ é™¤æˆ–ç¦ç”¨
              3. ä»£ç é‡æ„å¯¼è‡´æµ‹è¯•å¤±æ•ˆ
              4. æµ‹è¯•é…ç½®é—®é¢˜

              ### ğŸ› ï¸ ç«‹å³è¡ŒåŠ¨è®¡åˆ’

              \`\`\`bash
              # 1. æ¿€æ´»å¼€å‘ç¯å¢ƒ
              source scripts/activate-venv.sh

              # 2. è¿è¡Œè¦†ç›–ç‡åˆ†æ
              python scripts/automated_test_report.py

              # 3. æŸ¥çœ‹è¯¦ç»†è¦†ç›–ç‡æŠ¥å‘Š
              open htmlcov/index.html

              # 4. æ·»åŠ ç¼ºå¤±çš„æµ‹è¯•ç”¨ä¾‹
              pytest tests/ --cov=. --cov-report=html
              \`\`\`

              ### ğŸ¯ è¦†ç›–ç‡æå‡å»ºè®®

              - **å•å…ƒæµ‹è¯•**: ä¸ºæ–°å¢å‡½æ•°/æ–¹æ³•æ·»åŠ æµ‹è¯•
              - **é›†æˆæµ‹è¯•**: éªŒè¯ç»„ä»¶é—´çš„äº¤äº’
              - **è¾¹ç•Œæµ‹è¯•**: æµ‹è¯•å¼‚å¸¸æƒ…å†µå’Œè¾¹ç•Œæ¡ä»¶
              - **å›å½’æµ‹è¯•**: ç¡®ä¿ä¿®å¤ä¸ä¼šç ´åç°æœ‰åŠŸèƒ½

              ---
              **ä¼˜å…ˆçº§**: é«˜ â€¢ **æˆªæ­¢æ—¥æœŸ**: 7å¤©å†…è§£å†³
              `;

              // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç±»ä¼¼çš„Issue
              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'coverage-alert,automated'
              });

              const coverageIssue = existingIssues.data.find(issue =>
                issue.title.includes('æµ‹è¯•è¦†ç›–ç‡è­¦å‘Š')
              );

              if (!coverageIssue) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: issueBody,
                  labels: ['coverage-alert', 'automated', 'quality', 'high-priority']
                });
              }
            }

            // è®¾ç½®è¾“å‡ºä¾›å…¶ä»–æ­¥éª¤ä½¿ç”¨
            core.setOutput('coverage', currentCoverage);
            core.setOutput('status', alertLevel);

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: |
            coverage-current.json
            htmlcov/
          retention-days: 30
